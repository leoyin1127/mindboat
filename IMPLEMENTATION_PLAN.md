# MindBoat - Comprehensive Implementation Plan

## 1. Technical Architecture

### Production-Ready Tech Stack

**Frontend Stack:**
- **Framework**: React 18 + TypeScript + Vite (already configured)
- **State Management**: Zustand (lightweight, perfect for this use case)
- **Styling**: Tailwind CSS + Framer Motion (animations)
- **Audio**: Web Audio API + Tone.js (for ambient sounds)
- **Real-time**: WebRTC + WebSockets (for advanced monitoring)
- **Icons**: Lucide React (already included)

**Backend Stack:**
- **Database**: Supabase (PostgreSQL + Real-time subscriptions + Auth)
- **AI/LLM**: OpenAI GPT-4 or Anthropic Claude (via Supabase Edge Functions)
- **File Storage**: Supabase Storage (for generated images, audio clips)
- **Authentication**: Supabase Auth (email/password)
- **Real-time**: Supabase Realtime (for live session updates)

**Browser APIs for Distraction Detection:**
- **Page Visibility API**: Tab switching detection
- **MediaDevices API**: Optional camera/microphone access
- **Screen Capture API**: Optional screen sharing
- **Intersection Observer API**: Element visibility tracking
- **Web Workers**: Background processing without blocking UI

### Data Flow Architecture

```
Frontend (React) ←→ Supabase Client ←→ Supabase Backend
                                    ├── PostgreSQL Database
                                    ├── Edge Functions (AI Processing)
                                    ├── Realtime (Live Updates)
                                    └── Storage (Assets)
```

### Database Schema Design

```sql
-- Users table (handled by Supabase Auth)
-- Additional user preferences
create table user_profiles (
  id uuid references auth.users primary key,
  lighthouse_goal text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- Task destinations (generated by AI)
create table destinations (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users not null,
  original_task text not null,
  destination_name text not null,
  description text,
  related_apps text[], -- Array of app names/URLs
  color_theme text default '#3B82F6',
  created_at timestamptz default now()
);

-- Voyage sessions
create table voyages (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users not null,
  destination_id uuid references destinations not null,
  start_time timestamptz not null,
  end_time timestamptz,
  planned_duration integer, -- minutes
  actual_duration integer, -- minutes
  distraction_count integer default 0,
  status text check (status in ('active', 'completed', 'abandoned')),
  weather_mood text default 'sunny',
  created_at timestamptz default now()
);

-- Distraction events
create table distraction_events (
  id uuid primary key default gen_random_uuid(),
  voyage_id uuid references voyages not null,
  detected_at timestamptz default now(),
  duration_seconds integer,
  type text, -- 'tab_switch', 'idle', 'camera_distraction'
  user_response text -- 'return_to_course', 'exploring', 'ignored'
);

-- Daily reflections (Seagull Diary)
create table daily_reflections (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users not null,
  date date not null,
  reflection_text text,
  total_focus_time integer, -- minutes
  voyage_count integer,
  generated_at timestamptz default now(),
  unique(user_id, date)
);
```

## 2. Implementation Breakdown

### Phase 1: Foundation & Onboarding (Week 1-2)
**Estimated Time: 2 weeks**

#### Core Features:
- **Lighthouse Goal Setup** (3 days)
  - Animated onboarding flow
  - Goal input and validation
  - Visual metaphor introduction
  
- **Destination Creation** (4 days)
  - LLM integration for task transformation
  - Destination card generation
  - Related apps suggestion system
  
- **Authentication & User Management** (3 days)
  - Supabase Auth integration
  - User profile management
  - Data persistence setup

**Technical Challenges & Solutions:**
- **LLM Prompt Engineering**: Create consistent, creative destination names
  - Solution: Use structured prompts with examples and JSON schema validation
- **Real-time UI Updates**: Smooth animations during AI processing
  - Solution: Optimistic updates with loading states and error handling

### Phase 2: Core Sailing Experience (Week 3-5)
**Estimated Time: 3 weeks**

#### Core Features:
- **Sail Preparation Interface** (2 days)
  - Destination selection
  - Permission requests (camera, microphone)
  - Pre-voyage setup

- **Sailing Mode Visual System** (5 days)
  - Canvas-based boat animation
  - Dynamic weather/mood system
  - Trail rendering and persistence
  
- **Distraction Detection Engine** (7 days) ⚠️ **Most Complex**
  - Multi-modal detection system
  - Smart filtering and false-positive reduction
  - Real-time alert system
  
- **Response Handling** (3 days)
  - "Return to Course" vs "I'm Exploring" logic
  - State transitions and mode switching
  - Inspiration capture system

**Technical Challenges & Solutions:**
- **Browser Distraction Detection Limitations**: 
  - Solution: Layered approach using Page Visibility API + optional MediaDevices
  - Fallback to tab-switching detection only if permissions denied
- **Performance with Real-time Monitoring**:
  - Solution: Web Workers for background processing, throttled event handling
- **Cross-browser Compatibility**:
  - Solution: Progressive enhancement with feature detection

### Phase 3: Review & Visualization (Week 6-7)
**Estimated Time: 2 weeks**

#### Core Features:
- **Voyage Completion Flow** (3 days)
  - Summary statistics
  - Achievement visualization
  - Data persistence
  
- **Grand Map System** (4 days)
  - SVG-based route visualization
  - Interactive timeline
  - Progress tracking
  
- **AI-Generated Reflections** (4 days)
  - Daily summary generation
  - Seagull diary personality
  - Insight extraction from voyage data

**Technical Challenges & Solutions:**
- **Complex Data Visualization**: Large datasets for frequent users
  - Solution: Virtualization, progressive loading, and efficient SVG rendering
- **AI Consistency**: Maintaining seagull personality across reflections
  - Solution: Persistent context management and personality prompts

## 3. Code Structure

### Project Architecture
```
src/
├── components/           # Reusable UI components
│   ├── ui/              # Basic UI components (Button, Input, etc.)
│   ├── sailing/         # Sailing-specific components
│   ├── onboarding/      # Onboarding flow components
│   └── visualization/   # Charts, maps, animations
├── hooks/               # Custom React hooks
│   ├── useVoyage.ts     # Voyage state management
│   ├── useDistraction.ts # Distraction detection
│   └── useAudio.ts      # Ambient audio control
├── lib/                 # Utility libraries
│   ├── supabase.ts      # Supabase client configuration
│   ├── ai.ts            # AI/LLM utilities
│   ├── distraction.ts   # Detection algorithms
│   └── audio.ts         # Audio processing
├── stores/              # Zustand stores
│   ├── voyageStore.ts   # Current voyage state
│   ├── userStore.ts     # User profile and preferences
│   └── destinationStore.ts # Tasks and destinations
├── types/               # TypeScript type definitions
├── utils/               # Helper functions
└── pages/               # Main application pages
    ├── Onboarding.tsx
    ├── Dashboard.tsx
    ├── SailingMode.tsx
    └── MapView.tsx
```

### Example Core Components

#### Distraction Detection Hook
```typescript
// hooks/useDistraction.ts
import { useEffect, useRef, useState } from 'react';
import { useVoyageStore } from '../stores/voyageStore';

export interface DistractionEvent {
  type: 'tab_switch' | 'idle' | 'camera_distraction';
  timestamp: number;
  duration?: number;
}

export const useDistraction = () => {
  const [isDistracted, setIsDistracted] = useState(false);
  const [permissionsGranted, setPermissionsGranted] = useState({
    camera: false,
    microphone: false,
    screen: false
  });
  
  const distractionTimeoutRef = useRef<NodeJS.Timeout>();
  const { isVoyageActive, recordDistraction } = useVoyageStore();
  
  // Page Visibility API - Tab switching detection
  useEffect(() => {
    if (!isVoyageActive) return;
    
    const handleVisibilityChange = () => {
      if (document.hidden) {
        // User switched away from tab
        distractionTimeoutRef.current = setTimeout(() => {
          setIsDistracted(true);
          recordDistraction({
            type: 'tab_switch',
            timestamp: Date.now()
          });
        }, 15000); // 15 second threshold
      } else {
        // User returned to tab
        if (distractionTimeoutRef.current) {
          clearTimeout(distractionTimeoutRef.current);
        }
        setIsDistracted(false);
      }
    };
    
    document.addEventListener('visibilitychange', handleVisibilityChange);
    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      if (distractionTimeoutRef.current) {
        clearTimeout(distractionTimeoutRef.current);
      }
    };
  }, [isVoyageActive]);
  
  const requestPermissions = async () => {
    try {
      // Request camera and microphone permissions
      const stream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
      });
      
      setPermissionsGranted(prev => ({
        ...prev,
        camera: true,
        microphone: true
      }));
      
      // Setup advanced detection here...
      
      return stream;
    } catch (error) {
      console.warn('Advanced distraction detection unavailable:', error);
      // Fall back to basic tab-switching detection
      return null;
    }
  };
  
  return {
    isDistracted,
    permissionsGranted,
    requestPermissions
  };
};
```

#### AI Integration Service
```typescript
// lib/ai.ts
import { supabase } from './supabase';

interface DestinationRequest {
  task: string;
  userId: string;
}

interface DestinationResponse {
  destinationName: string;
  description: string;
  relatedApps: string[];
  colorTheme: string;
}

export class AIService {
  static async generateDestination(request: DestinationRequest): Promise<DestinationResponse> {
    const { data, error } = await supabase.functions.invoke('generate-destination', {
      body: {
        task: request.task,
        prompt: `Transform this user task into a magical sailing destination:
        
        Task: "${request.task}"
        
        Return a JSON object with:
        - destinationName: A creative, inspiring destination name in Chinese
        - description: A poetic 2-sentence description of this place
        - relatedApps: Array of 3-5 relevant applications/websites
        - colorTheme: A hex color that represents this destination
        
        Examples:
        Task: "Write research paper" → "学术大陆" (Academic Continent)
        Task: "Learn piano" → "艺术琴泉" (Artistic Piano Springs)
        Task: "Build app" → "代码峡湾" (Code Fjords)
        
        Make it magical and inspiring while being practical.`
      }
    });
    
    if (error) throw error;
    return data;
  }
  
  static async generateDailyReflection(voyageData: any[]): Promise<string> {
    const { data, error } = await supabase.functions.invoke('generate-reflection', {
      body: {
        voyageData,
        prompt: `As a wise seagull companion, write a brief daily reflection about the user's sailing journey today. Be encouraging, observant, and slightly playful. Focus on patterns, growth, and gentle insights. Keep it under 150 words and write from the seagull's perspective.`
      }
    });
    
    if (error) throw error;
    return data.reflection;
  }
}
```

### Testing Strategy

#### Unit Tests (Jest + Testing Library)
- **Component Tests**: Each UI component isolated
- **Hook Tests**: Custom hooks with various scenarios
- **Utility Tests**: AI prompts, distraction algorithms, audio processing

#### Integration Tests (Cypress)
- **User Flows**: Complete onboarding → sailing → completion flow  
- **Distraction Detection**: Simulated tab switching and recovery
- **Real-time Features**: Multi-tab synchronization

#### End-to-End Tests (Playwright)
- **Cross-browser Testing**: Chrome, Firefox, Safari
- **Permission Scenarios**: Camera/microphone granted/denied
- **Performance Testing**: Long sailing sessions, data persistence

## 4. Infrastructure Setup

### Supabase Configuration

#### Environment Variables
```env
# Frontend (.env)
VITE_SUPABASE_URL=your-project-url
VITE_SUPABASE_ANON_KEY=your-anon-key
VITE_OPENAI_API_KEY=your-openai-key (for Edge Functions)

# Edge Functions (.env)
OPENAI_API_KEY=your-openai-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

#### Row Level Security Policies
```sql
-- Enable RLS on all tables
alter table user_profiles enable row level security;
alter table destinations enable row level security;
alter table voyages enable row level security;
alter table distraction_events enable row level security;
alter table daily_reflections enable row level security;

-- Policies for user_profiles
create policy "Users can read own profile"
  on user_profiles for select
  using (auth.uid() = id);

create policy "Users can update own profile"
  on user_profiles for update
  using (auth.uid() = id);

-- Policies for destinations
create policy "Users can manage own destinations"
  on destinations for all
  using (auth.uid() = user_id);

-- Similar policies for other tables...
```

### Deployment Architecture

#### Production Setup (Recommended)
- **Frontend**: Vercel/Netlify (automatic deployments from git)
- **Backend**: Supabase (managed PostgreSQL + Edge Functions)
- **CDN**: Automatic via Vercel/Netlify
- **Domain**: Custom domain with SSL certificate
- **Monitoring**: Supabase built-in monitoring + Sentry for error tracking

#### CI/CD Pipeline (GitHub Actions)
```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm install
      - run: npm run test
      - run: npm run build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm install
      - run: npm run build
      - uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
```

### Security Measures

#### Frontend Security
- **Environment Variable Protection**: Only VITE_ prefixed vars exposed
- **Input Sanitization**: All user inputs validated and sanitized
- **XSS Protection**: Content Security Policy headers
- **HTTPS Only**: Secure connection enforcement

#### Backend Security  
- **Row Level Security**: Database-level access control
- **API Rate Limiting**: Prevent abuse via Supabase policies
- **Authentication**: JWT tokens with secure expiration
- **Data Validation**: Strong typing and validation on all inputs

#### Privacy Considerations
- **Minimal Data Collection**: Only essential voyage data
- **Permission-based Features**: Optional camera/microphone access
- **Data Retention Policies**: Automatic cleanup of old distraction events
- **User Control**: Easy data export and deletion

## 5. Maintenance Considerations

### Monitoring Strategy

#### Performance Monitoring
- **Core Web Vitals**: LCP, FID, CLS tracking via web-vitals library
- **Real User Monitoring**: Performance insights from actual users
- **API Response Times**: Supabase dashboard monitoring
- **Error Tracking**: Sentry integration for frontend errors

#### Business Metrics
- **User Engagement**: Average voyage duration, completion rates
- **Feature Usage**: Distraction detection accuracy, exploration mode usage
- **AI Performance**: Destination generation quality, reflection engagement
- **Retention**: Daily/weekly/monthly active users

### Scaling Recommendations

#### Horizontal Scaling (User Growth)
- **Database**: Supabase automatically scales PostgreSQL
- **Edge Functions**: Auto-scaling serverless functions
- **Frontend**: CDN distribution via Vercel/Netlify
- **API Rate Limits**: Implement per-user quotas for AI features

#### Vertical Scaling (Feature Complexity)
- **Advanced AI**: Multiple LLM providers with fallbacks
- **Real-time Collaboration**: Multiple users in shared voyages
- **Mobile Apps**: React Native with shared business logic
- **Offline Support**: Service worker implementation for core features

### Backup & Disaster Recovery

#### Data Backup Strategy
- **Automatic Backups**: Supabase provides daily automated backups
- **Point-in-time Recovery**: Up to 7 days of transaction log recovery
- **Cross-region Replication**: For enterprise users (future)
- **Export Capabilities**: User data export in JSON format

#### Service Continuity
- **Graceful Degradation**: Core features work without AI/advanced detection
- **Offline Voyage Mode**: Basic sailing experience with local storage
- **Multi-provider Strategy**: Backup AI providers for destination generation
- **Status Page**: Transparent service status communication

### Documentation Requirements

#### User Documentation
- **Onboarding Guide**: Interactive tutorial within the app
- **FAQ**: Common questions about distraction detection, privacy
- **Feature Guides**: How to use exploration mode, interpret reflections
- **Privacy Policy**: Clear explanation of data collection and usage

#### Technical Documentation
- **API Documentation**: Comprehensive Supabase function documentation
- **Deployment Guide**: Step-by-step production deployment
- **Contributing Guide**: For future open-source contributors
- **Architecture Decision Records**: Document key technical decisions

#### Maintenance Runbooks
- **Common Issues**: Troubleshooting guide for frequent problems
- **Performance Optimization**: Database query optimization, bundle size
- **Security Incident Response**: Procedures for security issues
- **Feature Rollout**: Safe deployment practices for new features

## Implementation Timeline Summary

**Total Estimated Time: 7-8 weeks**

- **Week 1-2**: Foundation & Onboarding (Authentication, Goal Setting, AI Integration)
- **Week 3-5**: Core Sailing Experience (Distraction Detection, Sailing Mode, Visual System)
- **Week 6-7**: Review & Visualization (Map System, Reflections, Polish)
- **Week 8**: Testing, Performance Optimization, Documentation

**Key Milestones:**
1. **Week 2**: User can create account, set goals, generate destinations
2. **Week 4**: Basic sailing mode with distraction detection working
3. **Week 6**: Complete user journey from onboarding to voyage completion
4. **Week 8**: Production-ready application with monitoring and documentation

**Critical Success Factors:**
- Distraction detection accuracy and user experience
- AI-generated content quality and consistency  
- Performance during long sailing sessions
- Intuitive and engaging visual metaphor implementation

This plan prioritizes the core user experience while building a maintainable, scalable foundation for future enhancements.